<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot + Canvas Code Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif
      }

      body {
        margin: 0;
        background: #4B5563;
        height: 100vh;
        display: flex;
        color: #e5e7eb;
        flex-direction: row;
        overflow-y: auto
      }

      .chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #6B7280
      }

      .canvas {
        width: 45%;
        display: flex;
        flex-direction: column;
        background: #4B5563
      }

      .hidden {
        display: none !important
      }

      .visible {
        display: flex !important
      }

      .header,
      .editor-header {
        padding: 16px 20px;
        border-bottom: 1px solid #6B7280;
        font-weight: 600;
        position: sticky;
        top: 0;
        background: #4B5563;
        z-index: 10
      }

      .messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 14px
      }

      .message {
        position: relative;
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 14px;
        animation: fadeIn 0.2s ease
      }

      .bot {
        background: #6B7280;
        align-self: flex-start
      }

      .user {
        background: #3B82F6;
        align-self: flex-end
      }

      .message:hover .timestamp {
        opacity: 1
      }

      .timestamp {
        position: absolute;
        bottom: -16px;
        font-size: 11px;
        color: #9CA3AF;
        opacity: 0
      }

      .input-area {
        display: flex;
        padding: 16px;
        border-top: 1px solid #6B7280;
        gap: 10px;
        position: sticky;
        bottom: 0;
        background: #4B5563;
        z-index: 10
      }

      .input-area input {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #6B7280;
        background: #4B5563;
        color: #e5e7eb
      }

      .input-area button {
        padding: 12px 16px;
        border: none;
        border-radius: 10px;
        background: #1D4ED8;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s
      }

      .input-area button:hover {
        background: #3B82F6
      }

      .codebox {
        background: #4B5563;
        border: 1px solid #9CA3AF;
        border-radius: 12px;
        overflow: hidden
      }

      .code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #4B5563;
        border-bottom: 1px solid #9CA3AF;
        font-size: 12px;
        color: #9CA3AF
      }

      .code-header button {
        background: none;
        border: none;
        color: #93C5FD;
        cursor: pointer;
        font-size: 12px;
        transition: color 0.2s
      }

      .code-header button:hover {
        color: #3B82F6
      }

      pre {
        margin: 0;
        padding: 14px;
        font-size: 13px;
        overflow: auto;
        color: #e5e7eb;
        font-family: monospace
      }

      .editor-header span {
        cursor: pointer
      }

      .editor-header button {
        background: none;
        border: none;
        color: #93C5FD;
        cursor: pointer;
        font-size: 13px;
        margin-left: 10px;
        transition: color 0.2s
      }

      .editor-header button:hover {
        color: #3B82F6
      }

      .editor {
        flex: 1;
        display: flex
      }

      .lines {
        background: #4B5563;
        padding: 10px 6px;
        color: #9CA3AF;
        text-align: right;
        user-select: none;
        font-family: monospace;
        font-size: 13px
      }

      textarea {
        flex: 1;
        background: #4B5563;
        color: #e5e7eb;
        border: none;
        padding: 10px;
        font-family: monospace;
        font-size: 13px;
        resize: none;
        outline: none
      }

      .console {
        height: 120px;
        border-top: 1px solid #6B7280;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
        color: #9CA3AF;
        overflow-y: auto;
        position: relative
      }

      .console button {
        position: absolute;
        top: 5px;
        right: 10px;
        background: none;
        border: none;
        color: #93C5FD;
        cursor: pointer;
        font-size: 12px
      }

      .typing-indicator {
        display: flex;
        align-items: center;
        background: #6B7280;
        padding: 12px 16px;
        border-radius: 14px;
        max-width: 75%;
        align-self: flex-start
      }

      .typing-indicator .dot {
        width: 6px;
        height: 6px;
        background: #9CA3AF;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out both
      }

      .typing-indicator .dot:nth-child(1) {
        animation-delay: -0.32s
      }

      .typing-indicator .dot:nth-child(2) {
        animation-delay: -0.16s
      }

      @keyframes typing {

        0%,
        80%,
        100% {
          transform: scale(0)
        }

        40% {
          transform: scale(1)
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(4px)
        }

        to {
          opacity: 1;
          transform: translateY(0)
        }
      }

      @media(max-width:768px) {
        .canvas {
          display: none !important
        }

        .chat {
          width: 100% !important;
          flex: 1
        }
      }
    </style>
  </head>
  <body>
    <div class="chat">
      <div class="header">Chatbot – /help for commands</div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input id="input" placeholder="Type a command like /help, /code, /aicode, /ask, /close" />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
    <div class="canvas hidden" id="canvas">
      <div class="editor-header">
        <span id="filename" ondblclick="editFilename(this)">example.js</span>
        <div>
          <button onclick="runCode()">Run</button>
          <button onclick="copyEditor()">Copy</button>
          <button onclick="clearEditor()">Clear</button>
          <button onclick="closeCanvas()">Close</button>
        </div>
      </div>
      <div class="editor">
        <div class="lines" id="lines">1</div>
        <textarea id="editor"></textarea>
      </div>
      <div class="console" id="console"> Console ready. <button onclick="clearConsole()">Clear</button>
      </div>
    </div>
    <script>
      const messages = document.getElementById('messages')
      const input = document.getElementById('input')
      const canvas = document.getElementById('canvas')
      const editor = document.getElementById('editor')
      const lines = document.getElementById('lines')
      const consoleEl = document.getElementById('console')
      const filenameEl = document.getElementById('filename')
      boot()

      function boot() {
        bot("Welcome!\n/help – commands\n/code – code demo\n/aicode – AI code in canvas\n/ask – AI answer\n/close – close canvas\n/echo [text] – echo\n/joke – joke");
        updateLines()
      }
      input.addEventListener('keydown', e => {
        if (e.key === 'Enter') sendMessage()
      })

      function sendMessage() {
        const t = input.value.trim();
        if (!t) return;
        user(t);
        input.value = '';
        showTypingIndicator();
        setTimeout(() => {
          handle(t);
          hideTypingIndicator()
        }, 800 + Math.random() * 800)
      }
      async function handle(t) {
        if (t === '/help') {
          bot('Commands:\n/help\n/code\n/aicode\n/ask\n/close\n/echo [text]\n/joke')
        } else if (t === '/code') {
          botCode('js', 'function hello(){console.log("Hello world");}')
        } else if (t === '/close') {
          closeCanvas();
          bot('Canvas closed.')
        } else if (t.startsWith('/echo ')) {
          bot(t.substring(6))
        } else if (t === '/joke') {
          bot('Why did the programmer quit his job? Because he didn\'t get arrays!')
        } else if (t.startsWith('/aicode')) {
          if (canvas.classList.contains('hidden')) {
            bot('Canvas disabled on mobile.')
          } else {
            bot('AI generating code…');
            const prompt = t.replace('/aicode', '').trim() || "Write JS code";
            const aiCode = await aiReply(prompt);
            if (aiCode.split('\n').length > 100) {
              openCanvas();
              clearEditor();
              typeInEditor(aiCode);
              bot('AI code inserted into canvas.')
            } else {
              botCode('js', aiCode)
            }
          }
        } else if (t.startsWith('/ask ')) {
          bot('AI thinking…');
          const aiAnswer = await aiReply(t.substring(5));
          bot(aiAnswer)
        } else {
          bot(`You said: "${t}". Try a command like /help!`)
        }
      }

      function openCanvas() {
        canvas.classList.remove('hidden');
        canvas.classList.add('visible')
      }

      function closeCanvas() {
        canvas.classList.remove('visible');
        canvas.classList.add('hidden')
      }

      function user(t) {
        add(t, 'user')
      }

      function bot(t) {
        const m = document.createElement('div');
        m.className = 'message bot';
        m.innerHTML = ' < span class = "bot-text" > < /span>';m.appendChild(ts());messages.appendChild(m);typeFast(m.querySelector('.bot-text'),t);messages.scrollTop=messages.scrollHeight}

        function add(t, type) {
          const m = document.createElement('div');
          m.className = 'message ' + type;
          m.innerHTML = format(t);
          m.appendChild(ts());
          messages.appendChild(m);
          messages.scrollTop = messages.scrollHeight
        }

        function botCode(lang, code) {
          const m = document.createElement('div');
          m.className = 'message bot';
          m.innerHTML = `
			<div class="codebox">
				<div class="code-header">
					<span>${lang}</span>
					<button onclick="copyCode(this)">Copy</button>
				</div>
				<pre>
					<code class="language-${lang}"></code>
				</pre>
			</div>`;
          messages.appendChild(m);
          const codeEl = m.querySelector('code');
          typeFast(codeEl, code, () => {
            Prism.highlightElement(codeEl)
          });
          m.appendChild(ts());
          messages.scrollTop = messages.scrollHeight
        }

        function typeFast(el, text, callback) {
          let i = 0;
          const iv = setInterval(() => {
            el.textContent += text[i++] || '';
            if (i >= text.length) {
              clearInterval(iv);
              if (callback) callback()
            }
          }, 8)
        }

        function typeInEditor(text) {
          let i = 0;
          editor.focus();
          const iv = setInterval(() => {
            editor.value += text[i++] || '';
            updateLines();
            editor.scrollTop = editor.scrollHeight;
            if (i >= text.length) {
              clearInterval(iv);
              appendToConsole('AI finished typing code.')
            }
          }, 20)
        }

        function format(t) {
          return t.replace(/\n/g, ' < br > ')}function ts() {
                const d = document.createElement('div');
                d.className = 'timestamp';
                d.textContent = new Date().toLocaleTimeString();
                return d
              }

              function copyCode(btn) {
                const code = btn.parentElement.nextElementSibling.textContent;
                navigator.clipboard.writeText(code);
                btn.textContent = 'Copied';
                setTimeout(() => btn.textContent = 'Copy', 800)
              }

              function copyEditor() {
                navigator.clipboard.writeText(editor.value)
              }

              function clearEditor() {
                editor.value = '';
                updateLines()
              }

              function runCode() {
                const code = editor.value;
                if (!code.trim()) {
                  appendToConsole('No code to run.', true);
                  return
                }
                appendToConsole('--- Running code ---');
                const originalConsoleLog = console.log;
                console.log = (...args) => {
                  appendToConsole(args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' '))
                };
                let result;
                try {
                  result = eval(code);
                  if (result !== undefined) {
                    appendToConsole(`Return value: ${typeof result==='object'?JSON.stringify(result):result}`)
                  } else {
                    appendToConsole('Executed successfully (no return value).')
                  }
                } catch (e) {
                  appendToConsole(`Error: ${e.message}`, true)
                } finally {
                  console.log = originalConsoleLog
                }
              }

              function appendToConsole(msg, isError = false) {
                const line = document.createElement('div');
                line.textContent = msg;
                if (isError) line.style.color = '#ef4444';
                consoleEl.insertBefore(line, consoleEl.querySelector('button'));
                consoleEl.scrollTop = consoleEl.scrollHeight
              }

              function clearConsole() {
                consoleEl.innerHTML = '';
                const btn = document.createElement('button');
                btn.textContent = 'Clear';
                btn.onclick = clearConsole;
                consoleEl.appendChild(btn);
                appendToConsole('Console cleared.')
              }

              function updateLines() {
                const count = Math.max(editor.value.split('\n').length, 1);
                lines.innerHTML = Array.from({
                    length: count
                  }, (_, i) => i + 1).join(' < br > ')}
                    editor.addEventListener('input', updateLines)
                    function editFilename(el) {
                      const input = document.createElement('input');
                      input.value = el.textContent;
                      input.style.width = 'auto';
                      input.style.background = 'transparent';
                      input.style.border = '1px solid #334155';
                      input.style.color = '#94a3b8';
                      el.replaceWith(input);
                      input.focus();
                      input.addEventListener('blur', () => {
                        el.textContent = input.value || 'example.js';
                        input.replaceWith(el)
                      });
                      input.addEventListener('keydown', e => {
                        if (e.key === 'Enter') input.blur()
                      })
                    }
                    let typingIndicator = null

                    function showTypingIndicator() {
                      typingIndicator = document.createElement('div');
                      typingIndicator.className = 'typing-indicator message bot';
                      typingIndicator.innerHTML = ' < div class = "dot" > < /div> < div class = "dot" > < /div> < div class = "dot" > < /div>';messages.appendChild(typingIndicator);messages.scrollTop=messages.scrollHeight}

                      function hideTypingIndicator() {
                        if (typingIndicator) {
                          typingIndicator.remove();
                          typingIndicator = null
                        }
                      }
                      async function aiReply(prompt) {
                        try {
                          const res = await fetch("https://apifreellm.com/api/chat", {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                              message: prompt
                            })
                          });
                          const j = await res.json();
                          if (j.status === "success" && j.response) return j.response;
                          return "AI error or rate limit, try again"
                        } catch (e) {
                          return "Network or AI error: " + e.message
                        }
                      }
    </script>
  </body>
</html>
